// ---- handle POST /control ----
if (strncmp(req, "POST /control", strlen("POST /control")) == 0)
{
char *body_start = strstr(req, "\r\n\r\n");
if (body_start)
{
body_start += 4;

cJSON *json = cJSON_Parse(body_start);
if (json)
{
cJSON *led = cJSON_GetObjectItemCaseSensitive(json, "led");
if (cJSON_IsNumber(led))
{
slave_input = (uint8_t)led->valueint; // outgoing command TO SLAVE
}
cJSON_Delete(json);
}
}

// ---- build JSON response including LED and temp returned FROM SLAVE ----
char body[128];
int body_len = snprintf(body, sizeof(body),
"{"
"\"control\": %d,"
"\"led_state\": %d,"
"\"temp_raw\": %u"
"}",
(int)slave_input,
(int)current_led_byte,
(unsigned)current_temp_raw);

char header[128];
int hlen = snprintf(header, sizeof(header),
"HTTP/1.1 200 OK\r\n"
"Content-Type: application/json\r\n"
"Content-Length: %d\r\n"
"Connection: close\r\n\r\n",
body_len);

tcp_write(pcb, header, hlen, TCP_WRITE_FLAG_COPY);
tcp_write(pcb, body, body_len, TCP_WRITE_FLAG_COPY);
tcp_output(pcb);
tcp_close(pcb);
return ERR_OK;
}